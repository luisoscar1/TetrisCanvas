<!-- 
profe utilize su coddigo para no complicarme

-->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
        Tetris
    </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.10.0/p5.min.js"></script>
    <style type="text/css">
        body {
            background-color: gray;
        }

        canvas {
            background-color: white;
        }
    </style>
</head>

<body>

    <!-- <canvas id="myCanvas" width="600" height="500"></canvas>
 -->
    <script type="text/javascript">
        /* const myCanvas = document.getElementById("myCanvas");
        const ctx = myCanvas.getContext("2d"); */

        var direction = '';
        const tamañoBloque = 30;
        const bordeAncho = 10;
        const bordeAlto = 20;
        const margenTablero = 20;
        function setup() {
            createCanvas(900, 600)
            tablero = new Tablero()
            mapeo()
            tetrimino = new Tetrimino()

            resizeCanvas(tablero.ancho + margenTablero, tablero.alto + margenTablero)
        }

        function draw() {
            tablero.dibujar()
            tetrimino.dibujar()
            update()
        }

        class Tablero {
            constructor() {
                this.columnas = 10
                this.filas = 20
                this.lado_celda = 25
                this.ancho = this.columnas * this.lado_celda
                this.alto = this.filas * this.lado_celda
                this.posicion = createVector(5, 2)

                this.almacenar = [];
                for (let filas = 0; filas < this.filas; filas++) {
                    this.almacenar[filas] = [];
                    for (let columnas = 0; columnas < this.columnas; columnas++) {
                        this.almacenar[filas].push("")

                    }

                }

            }

            /* set almacenarMinos(tetrimino) {
                for (const tetri of tetrimino.mapaTablero) {

                    this.almacenar[tetri.x][tetri.y] = tetrimino.nombre
                }
            } */
            set almacenarMinos(tetrimino) {
                for (const tetri of tetrimino.mapaTablero) {
                    this.almacenar[tetri.x][tetri.y] = { nombre: tetrimino.nombre, color: tetrimino.color };
                }
            }

            coordenada(x, y) {
                return createVector(x, y).mult(this.lado_celda).add(this.posicion)
            }

            dibujar() {
                for (let columnas = 0; columnas < this.columnas; columnas++) {
                    for (let filas = 0; filas < this.filas; filas++) {
                        let c = this.coordenada(columnas, filas)
                        rect(c.x, c.y, this.lado_celda)
                    }
                }
                this.dibujarMinos()
            }


            /* dibujarMinos() {
                push()
                for (let columnas = 0; columnas < this.columnas; columnas++) {
                    for (let filas = 0; filas < this.filas; filas++) {
                        let nombreTetri = this.almacenar[columnas][filas];

                        if (this.almacenar[columnas][filas]) {
                            fill(tetriminoBase[nombreTetri].color)

                            Tetrimino.dibujarTetri(this.coordenada(columnas, filas))

                        }
                    }
                }
                pop()
            } */
            dibujarMinos() {
                push()
                for (let columnas = 0; columnas < this.columnas; columnas++) {
                    for (let filas = 0; filas < this.filas; filas++) {
                        let celda = this.almacenar[columnas][filas];
                        if (celda) {
                            fill(celda.color); // Usar el color almacenado en la celda
                            Tetrimino.dibujarTetri(this.coordenada(columnas, filas));
                        }
                    }
                }
                pop()
            }

        }

        function mapeo() {
            tetriminos = {
                "Z": {
                    color: "blue",
                    mapa: [
                        createVector(),
                        createVector(-1, -1),
                        createVector(0, -1),
                        createVector(1, 0)
                    ]
                },
                "S": {
                    color: "red",
                    mapa: [
                        createVector(),
                        createVector(1, -1),
                        createVector(0, -1),
                        createVector(-1, 0)
                    ]
                },
                "J": {
                    color: "yellow",
                    mapa: [
                        createVector(),
                        createVector(-1, 0),
                        createVector(-1, -1),
                        createVector(1, 0)
                    ]
                },
                "L": {
                    color: "pink",
                    mapa: [
                        createVector(),
                        createVector(-1, 0),
                        createVector(1, -1),
                        createVector(1, 0)
                    ]
                },
                "T": {
                    color: "orange",
                    mapa: [
                        createVector(),
                        createVector(-1, 0),
                        createVector(1, 0),
                        createVector(0, -1)
                    ]
                },
                "O": {
                    color: "purple",
                    mapa: [
                        createVector(),
                        createVector(0, -1),
                        createVector(1, -1),
                        createVector(1, 0)
                    ]
                },
                "I": {
                    color: "red",
                    mapa: [
                        createVector(),
                        createVector(-1, 0),
                        createVector(1, 0),
                        createVector(2, 0)
                    ]
                }
            }
        }

        class Tetrimino {
            constructor(nombre = random(["I", "O", "T", "L", "J", "S", "Z"])) {
                this.nombre = nombre
                let tetriminoBase = tetriminos[nombre]
                this.color = tetriminoBase.color
                this.mapa = []
                for (const tetri of tetriminoBase.mapa) {
                    this.mapa.push(tetri.copy())
                }
                this.posicion = createVector(4, 1)
            }

            girar() {
                for (const tetri of this.mapa) {
                    tetri.set(tetri.y, -tetri.x);
                }
                if (this.colisionesEntreEllos) {
                    this.desgirar();
                }
            }

            // Método para deshacer la rotación
            desgirar() {
                for (const tetri of this.mapa) {
                    tetri.set(-tetri.y, tetri.x);
                }
            }
            /* girar() {
                for (const tetri of this.mapa) {
                    tetri.set(tetri.y, -tetri.x)

                }
                if (this.errores) {
                    this.desgirar()
                }
            }

            desgirar() {
                for (const tetri of this.mapa) {
                    tetri.set(-tetri.y, tetri.x)

                }
            }
 */
            get errores() {
                return !tetrimino.colisiones || this.colisionesEntreEllos;
            }

            /* get colisionesEntreEllos() {
                for (const tetri of this.mapaTablero) {
                    if (tablero.almacenar[tetri.x][tetri.y]) {
                        return true
                    }
                }


                return false
            } */

            get colisionesEntreEllos() {
                for (const tetri of this.mapaTablero) {
                    if (tetri.x < 0 || tetri.x >= tablero.columnas || tetri.y >= tablero.filas) {
                        return true; // Colisión con el borde del tablero
                    }
                    if (tablero.almacenar[tetri.x][tetri.y]) {
                        return true; // Colisión con otro tetrimino
                    }
                }
                return false;
            }

            /*  get colisiones() {
                 for (const tetri of this.mapaTablero) {
 
                     if (tetri.x < 0) {
                         return false;
                     }
 
                     if (tetri.x >= tablero.columnas) {
                         return false;
                     }
 
                     if (tetri.y >= tablero.filas) {
                         return false;
                     }
 
 
                 }
                 return true;
             } */
            get colisiones() {
                for (const tetri of this.mapaTablero) {
                    if (tetri.x < 0 || tetri.x >= tablero.columnas || tetri.y >= tablero.filas) {
                        return false; // Fuera de los límites del tablero
                    }
                }
                return true;
            }
            //nuevo
            colocarEnTablero() {
                for (const tetri of this.mapaTablero) {
                    if (tetri.x >= 0 && tetri.x < tablero.columnas && tetri.y >= 0 && tetri.y < tablero.filas) {
                        tablero.almacenar[tetri.x][tetri.y] = { nombre: this.nombre, color: this.color };
                    }
                }
            }

            get mapaTablero() {
                let retorno = []
                for (const tetri of this.mapa) {
                    let copiar = tetri.copy().add(this.posicion)
                    retorno.push(copiar)
                }
                return retorno
            }

            get mapaCanvas() {
                let retorno = []
                for (const tetri of this.mapa) {
                    let copiar = tetri.copy().add(this.posicion)
                    retorno.push(tablero.coordenada(copiar.x, copiar.y))
                }
                return retorno
            }

            dibujar() {
                push()
                fill(this.color)
                for (const tetri of this.mapaCanvas) {
                    Tetrimino.dibujarTetri(tetri)
                }
                pop()
            }

            static dibujarTetri(tetri) {
                rect(tetri.x, tetri.y, tablero.lado_celda)

            }


        }

        document.addEventListener('keydown', function (e) {
            switch (e.key) {
                case 'w':
                    direction = 'up';
                    break;
                case 's':
                    direction = 'down';

                    break;
                case 'a':
                    direction = 'left';
                    break;
                case 'd':
                    direction = 'right';
                    break;
            }
        });


        /* function update() {
            switch (direction) {
                case 'up':
                    tetrimino.girar()
                    break;
                case 'down':
                    tetrimino.posicion.y++;
                    if (!tetrimino.colisiones) {
                        tetrimino.posicion.y--;
                        tablero.almacenarMinos = tetrimino;
                        tetrimino = new Tetrimino()
                    }
                    break;
                case 'right':
                    tetrimino.posicion.x++;
                    if (!tetrimino.colisiones) {
                        tetrimino.posicion.x--;
                    }
                    break;
                case 'left':
                    tetrimino.posicion.x--;
                    if (!tetrimino.colisiones) {
                        tetrimino.posicion.x++;
                    }
                    break;
            }
            direction = '';
        } */
        function update() {
            switch (direction) {
                case 'up':
                    tetrimino.girar();
                    break;
                case 'down':
                    tetrimino.posicion.y++;
                    if (tetrimino.colisionesEntreEllos) {
                        tetrimino.posicion.y--;
                        tetrimino.colocarEnTablero();
                        tetrimino = new Tetrimino();
                    }
                    break;
                case 'right':
                    tetrimino.posicion.x++;
                    if (tetrimino.colisionesEntreEllos) {
                        tetrimino.posicion.x--;
                    }
                    break;
                case 'left':
                    tetrimino.posicion.x--;
                    if (tetrimino.colisionesEntreEllos) {
                        tetrimino.posicion.x++;
                    }
                    break;
            }
            direction = '';
        }

    </script>
</body>

</html>