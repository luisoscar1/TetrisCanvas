<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
        Tetris
    </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.10.0/p5.min.js"></script>
    <style type="text/css">
        body {
            background-color: gray;
        }

        canvas {
            background-color: white;
        }
    </style>
</head>

<body>

    <script type="text/javascript">


        var direction = '';
        const tamañoBloque = 30;
        const bordeAncho = 10;
        const bordeAlto = 20;
        const margenTablero = 20;
        var pausado = false;



        function setup() {
            createCanvas(900, 600)
            tablero = new Tablero()
            mapeo()
            tetrimino = new Tetrimino()

            
            setInterval(bajarAutomaticamente, 1000);

        }

        function bajarAutomaticamente() {

            tetrimino.posicion.y++;
            if (tetrimino.colisionesEntreEllos) {
                tetrimino.posicion.y--;
                tetrimino.colocarEnTablero();

                let nuevoTetrimino = new Tetrimino();
                if (nuevoTetrimino.colisionesEntreEllos) {
                    tablero = new Tablero();
                    tetrimino = new Tetrimino();
                } else {
                    tetrimino = nuevoTetrimino;
                }
            }
        }

        
        function draw() {
            if (pausado) {
                mostrarPausa();
            } else {
                background(255); 
                tablero.dibujar();
                tetrimino.dibujar();
                update();
            }
        }

        function bajarAutomaticamente() {
            if (!pausado) { 
                tetrimino.posicion.y++;
                if (tetrimino.colisionesEntreEllos) {
                    tetrimino.posicion.y--;
                    tetrimino.colocarEnTablero();

                    let nuevoTetrimino = new Tetrimino();
                    if (nuevoTetrimino.colisionesEntreEllos) {
                        tablero = new Tablero();
                        tetrimino = new Tetrimino();
                    } else {
                        tetrimino = nuevoTetrimino;
                    }
                }
            }
        }


        function mostrarPausa() {
            fill("#bcbbcd");
            rect(0, 0, width, height);
            textSize(55);
            fill(0);
            textAlign(CENTER, CENTER);
            text("PAUSE", width / 2, height / 2);
        }

        class Tablero {
            constructor() {
                this.columnas = 10
                this.filas = 20
                this.lado_celda = 25
                this.ancho = this.columnas * this.lado_celda
                this.alto = this.filas * this.lado_celda
                this.posicion = createVector(5, 2)

                this.almacenar = [];
                for (let filas = 0; filas < this.filas; filas++) {
                    this.almacenar[filas] = [];
                    for (let columnas = 0; columnas < this.columnas; columnas++) {
                        this.almacenar[filas].push("")

                    }

                }

            }

            eliminarFilasCompletas() {
                for (let fila = this.filas - 1; fila >= 0; fila--) {
                    let filaCompleta = true;
                    for (let columna = 0; columna < this.columnas; columna++) {
                        if (!this.almacenar[columna][fila]) {
                            filaCompleta = false;
                            break;
                        }
                    }

                    if (filaCompleta) {
                        this.eliminarFila(fila);
                        fila++;
                    }
                }
            }

            eliminarFila(fila) {

                for (let y = fila; y > 0; y--) {
                    for (let columna = 0; columna < this.columnas; columna++) {
                        this.almacenar[columna][y] = this.almacenar[columna][y - 1];
                    }
                }

                for (let columna = 0; columna < this.columnas; columna++) {
                    this.almacenar[columna][0] = "";
                }
            }
            set almacenarMinos(tetrimino) {
                for (const tetri of tetrimino.mapaTablero) {

                    if (tetri.y < 0) {
                        tablero = new Tablero()
                        tetrimino = new Tetrimino()
                    }

                    this.almacenar[tetri.x][tetri.y] = { nombre: tetrimino.nombre, color: tetrimino.color };
                }
            }

            coordenada(x, y) {
                return createVector(x, y).mult(this.lado_celda).add(this.posicion)
            }

            dibujar() {
                for (let columnas = 0; columnas < this.columnas; columnas++) {
                    for (let filas = 0; filas < this.filas; filas++) {
                        let c = this.coordenada(columnas, filas)
                        rect(c.x, c.y, this.lado_celda)
                    }
                }
                this.dibujarMinos()
            }



            dibujarMinos() {
                push()
                for (let columnas = 0; columnas < this.columnas; columnas++) {
                    for (let filas = 0; filas < this.filas; filas++) {
                        let celda = this.almacenar[columnas][filas];
                        if (celda) {
                            fill(celda.color);
                            Tetrimino.dibujarTetri(this.coordenada(columnas, filas));
                        }
                    }
                }
                pop()
            }

        }







        function mapeo() {
            tetriminos = {
                "Z": {
                    color: "blue",
                    mapa: [
                        createVector(),
                        createVector(-1, -1),
                        createVector(0, -1),
                        createVector(1, 0)
                    ]
                },
                "S": {
                    color: "red",
                    mapa: [
                        createVector(),
                        createVector(1, -1),
                        createVector(0, -1),
                        createVector(-1, 0)
                    ]
                },
                "J": {
                    color: "yellow",
                    mapa: [
                        createVector(),
                        createVector(-1, 0),
                        createVector(-1, -1),
                        createVector(1, 0)
                    ]
                },
                "L": {
                    color: "pink",
                    mapa: [
                        createVector(),
                        createVector(-1, 0),
                        createVector(1, -1),
                        createVector(1, 0)
                    ]
                },
                "T": {
                    color: "orange",
                    mapa: [
                        createVector(),
                        createVector(-1, 0),
                        createVector(1, 0),
                        createVector(0, -1)
                    ]
                },
                "O": {
                    color: "purple",
                    mapa: [
                        createVector(),
                        createVector(0, -1),
                        createVector(1, -1),
                        createVector(1, 0)
                    ]
                },
                "I": {
                    color: "red",
                    mapa: [
                        createVector(),
                        createVector(-1, 0),
                        createVector(1, 0),
                        createVector(2, 0)
                    ]
                }
            }
        }

        class Tetrimino {
            constructor(nombre = random(["I", "O", "T", "L", "J", "S", "Z"])) {
                this.nombre = nombre
                let tetriminoBase = tetriminos[nombre]
                this.color = tetriminoBase.color
                this.mapa = []
                for (const tetri of tetriminoBase.mapa) {
                    this.mapa.push(tetri.copy())
                }
                this.posicion = createVector(4, 1)
            }

            girar() {
                for (const tetri of this.mapa) {
                    tetri.set(tetri.y, -tetri.x);
                }
                if (this.colisionesEntreEllos) {
                    this.desgirar();
                }
            }


            desgirar() {
                for (const tetri of this.mapa) {
                    tetri.set(-tetri.y, tetri.x);
                }
            }

            get enElTope() {

                return this.mapaTablero.some(tetri => tetri.y < 0);
            }


            get errores() {
                return !tetrimino.colisiones || this.colisionesEntreEllos;
            }



            get colisionesEntreEllos() {
                for (const tetri of this.mapaTablero) {
                    if (tetri.x < 0 || tetri.x >= tablero.columnas || tetri.y >= tablero.filas) {
                        return true;
                    }
                    if (tablero.almacenar[tetri.x][tetri.y]) {
                        return true;
                    }
                }
                return false;
            }


            get colisiones() {
                for (const tetri of this.mapaTablero) {
                    if (tetri.x < 0 || tetri.x >= tablero.columnas || tetri.y >= tablero.filas) {
                        return false;
                    }
                }
                return true;
            }


            colocarEnTablero() {
                let tetriminoAlTope = false;

                for (const tetri of this.mapaTablero) {
                    if (tetri.y < 0) {
                        tetriminoAlTope = true;
                    }

                    if (tetri.x >= 0 && tetri.x < tablero.columnas && tetri.y >= 0 && tetri.y < tablero.filas) {
                        tablero.almacenar[tetri.x][tetri.y] = { nombre: this.nombre, color: this.color };
                    }
                }

                if (tetriminoAlTope) {
                    tablero = new Tablero();
                    tetrimino = new Tetrimino();
                    console.log('Juego reiniciado: tetrimino alcanzó el tope');
                } else {
                    tablero.eliminarFilasCompletas();
                }
            }

            get mapaTablero() {
                let retorno = []
                for (const tetri of this.mapa) {
                    let copiar = tetri.copy().add(this.posicion)
                    retorno.push(copiar)
                }
                return retorno
            }

            get mapaCanvas() {
                let retorno = []
                for (const tetri of this.mapa) {
                    let copiar = tetri.copy().add(this.posicion)
                    retorno.push(tablero.coordenada(copiar.x, copiar.y))
                }
                return retorno
            }

            dibujar() {
                push()
                fill(this.color)
                for (const tetri of this.mapaCanvas) {
                    Tetrimino.dibujarTetri(tetri)
                }
                pop()
            }

            static dibujarTetri(tetri) {
                rect(tetri.x, tetri.y, tablero.lado_celda)

            }


        }

        function keyPressed() {
            if (key === ' ') {
                pausado = !pausado;
            } else if (!pausado) {
                switch (key) {
                    case 'w':
                        direction = 'up';
                        break;
                    case 's':
                        direction = 'down';
                        break;
                    case 'a':
                        direction = 'left';
                        break;
                    case 'd':
                        direction = 'right';
                        break;
                }
            }
        }

       
        function update() {
            switch (direction) {
                case 'up':
                    tetrimino.girar();
                    break;
                case 'down':
                    tetrimino.posicion.y++;
                    if (tetrimino.colisionesEntreEllos) {
                        tetrimino.posicion.y--;
                        tetrimino.colocarEnTablero();

                        let nuevoTetrimino = new Tetrimino();
                        if (nuevoTetrimino.colisionesEntreEllos) {
                            tablero = new Tablero();
                            tetrimino = new Tetrimino();
                        } else {
                            tetrimino = nuevoTetrimino;
                        }
                    }
                    break;
                case 'right':
                    tetrimino.posicion.x++;
                    if (tetrimino.colisionesEntreEllos) {
                        tetrimino.posicion.x--;
                    }
                    break;
                case 'left':
                    tetrimino.posicion.x--;
                    if (tetrimino.colisionesEntreEllos) {
                        tetrimino.posicion.x++;
                    }
                    break;
            }
            direction = '';
        }

    </script>
</body>

</html>